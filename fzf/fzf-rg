#!/usr/bin/env bash

# file: fzf-rg

# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# DO NOT EDIT THIS FILE! It was created automatically with chezmoi (for btn6m5)
# Run 'chezmoi apply' to rebuild it. All your changes will be lost upon recreation. 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

# Switch between Ripgrep launcher mode (CTRL-R) and fzf filtering mode (CTRL-F)
TMP_FILE_PREFIX="/tmp/rg-fzf-${USER}-"
RG_PREFIX="rg --column --line-number --no-heading --color=always --smart-case "
INITIAL_QUERY="${*:-}"
PREVIEW_CMD='fzf-preview {1}:{2}'
PREVIEW_WINDOW='right,40%,+{2}+3/3,~3'

MANPAGE=$(cat <<EOF
Content based file selector

 ENTER   : return selection 
 C-d     : return dir of selection
 C-e     : open selection with editor
 C-o     : open selection

 C-f     : switch to fuzzy search
 C-g     : switch to grep search (default)

 TAB     : start name based selector in cwd

 A-h     : search hidden files below cwd 
 A-H     : do not search hidden files below cwd
           (default)

 A-UP    : move cwd to home dir
 A-LEFT  : move cwd up one dir
 A-RIGHT : move cwd down one dir towards selection
 A-DOWN  : move cwd down to dir of selection

 A-m     : show this info
 A-p     : toggle preview window

EOF
)

PARENT_DIRECTORY=$(readlink -m "${PWD}/..")

rm -f ${TMP_FILE_PREFIX}{r,f,R,F,o}
touch ${TMP_FILE_PREFIX}{r,f,o}

: | fzf --ansi --disabled --query "$INITIAL_QUERY" \
    --bind "start:reload(echo {q} > ${TMP_FILE_PREFIX}r; touch "${TMP_FILE_PREFIX}R"; $RG_PREFIX \$(cat ${TMP_FILE_PREFIX}o) {q} || true)+unbind(ctrl-g)" \
    --bind "change:reload:sleep 0.1; $RG_PREFIX \$(cat ${TMP_FILE_PREFIX}o) {q} || true" \
    --bind "ctrl-f:unbind(change,ctrl-f)+transform-prompt(echo \(g:{q}\) f\>\ )+enable-search+rebind(ctrl-g)+transform-query(echo {q} > ${TMP_FILE_PREFIX}r; rm -f ${TMP_FILE_PREFIX}R; touch ${TMP_FILE_PREFIX}F; cat ${TMP_FILE_PREFIX}f)" \
    --bind "ctrl-g:unbind(ctrl-g)+transform-prompt(echo \(f:{q}\) g\>\ )+disable-search+reload($RG_PREFIX \$(cat ${TMP_FILE_PREFIX}o) {q} || true)+rebind(change,ctrl-f)+transform-query(rm -f ${TMP_FILE_PREFIX}F; touch ${TMP_FILE_PREFIX}R; echo {q} > ${TMP_FILE_PREFIX}f; cat ${TMP_FILE_PREFIX}r)" \
    --color "hl:-1:underline,hl+:-1:underline:reverse" \
    --prompt "(f:) g> " \
    --delimiter : \
    --header-first \
    --header "(grep) ${PWD}" \
    --border=rounded \
    --preview "${PREVIEW_CMD}" \
    --preview-window "$PREVIEW_WINDOW" \
    --height ${FZF_TMUX_HEIGHT:-90%} \
    --reverse  \
    --bind 'alt-p:change-preview-window(right,70%|down,70%|down,40%|left,40%|left,70%|hidden|right,40%)' \
    --bind "alt-m:preview(echo \"${MANPAGE}\"; sleep 3; clear; ${PREVIEW_CMD})" \
    --bind "alt-h:unbind(alt-h)+reload(echo "--hidden" > ${TMP_FILE_PREFIX}o; $RG_PREFIX \$(cat ${TMP_FILE_PREFIX}o) {q} || true)+rebind(alt-H)" \
    --bind "alt-H:unbind(alt-H)+reload(echo "" > ${TMP_FILE_PREFIX}o; $RG_PREFIX \$(cat ${TMP_FILE_PREFIX}o) {q} || true)+rebind(alt-h)" \
    --bind     "enter:become(__SEL=\"\$(readlink -m {1})\"; 
                                echo \${__SEL}:{2})" \
    --bind    "ctrl-e:become(__SEL=\"\$(readlink -m {1})\"; 
                                echo \"edit \${__SEL} (l. {2})\"; \"\$EDITOR\" \${__SEL} +{2})" \
    --bind    "ctrl-o:become(__SEL=\"\$(readlink -m {1})\"; 
                                echo \"open \${__SEL}\"; rifle \${__SEL})" \
    --bind    "ctrl-d:become(__SEL=\$(readlink -m \"\$(echo {1})\"); [ ! -d \"\${__SEL}\" ] && __SEL=\"\$(dirname \"\${__SEL}\")\"; \
                                echo \"\${__SEL}\")" \
    --bind       "tab:become(__QRY={q}; [ -f ${TMP_FILE_PREFIX}R ] && __QRY=\$(cat ${TMP_FILE_PREFIX}f); \
			     __SEL=\$(readlink -m \"\$(echo {1})\"); [ ! -d \"\${__SEL}\" ] && __SEL=\"\$(dirname \"\${__SEL}\")\"; \
				fzf-fd \"\${__SEL}\" \${__QRY})" \
    --bind    "alt-up:become(__QRY={q}; [ -f ${TMP_FILE_PREFIX}F ] && __QRY=\$(cat ${TMP_FILE_PREFIX}r); \
    			        cd ~; \
				fzf-rg \${__QRY})" \
    --bind  "alt-down:become(__QRY={q}; [ -f ${TMP_FILE_PREFIX}F ] && __QRY=\$(cat ${TMP_FILE_PREFIX}r); \
          		     __SEL={1};  [ ! -d \"\${__SEL}\" ] && __SEL=\"\$(dirname \"\${__SEL}\")\"; \
			        cd \"\${__SEL}\"; \
				fzf-rg \${__QRY})" \
    --bind  "alt-left:become(__QRY={q}; [ -f ${TMP_FILE_PREFIX}F ] && __QRY=\$(cat ${TMP_FILE_PREFIX}r); \
    			        cd \"${PARENT_DIRECTORY}\"; \
				fzf-rg \${__QRY})" \
    --bind "alt-right:become(__QRY={q}; [ -f ${TMP_FILE_PREFIX}F ] && __QRY=\$(cat ${TMP_FILE_PREFIX}r); \
          		     __SEL={1};  [ ! -d \"\${__SEL}\" ] && __SEL=\"\$(dirname \"\${__SEL}\")\"; \
    			     __SEL="\${__SEL}/"; __SEL=\"\${__SEL%\${__SEL#*/}}\"; \
			        cd \"\${__SEL}\"; \
				fzf-rg \${__QRY})" 

# EOF
